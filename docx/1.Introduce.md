Infrastructure as Code
----------------------

Tá»« cÃ¡i tÃªn cá»§a Infrastructure as Code thÃ¬ ta cÃ³ thá»ƒ hiá»ƒu Ä‘Æ¡n giáº£n lÃ  ta sáº½ viáº¿t code Ä‘á»ƒ mÃ´ táº£ vÃ  cung cáº¥p (provisioning) infrastructure cá»§a chÃºng ta ğŸ˜. Tá»« Infrastructure tiáº¿ng viá»‡t cÃ³ nghÄ©a lÃ  háº¡ táº§ng, cÃ²n á»Ÿ trong ngÃ nh IT cá»§a chÃºng ta thÃ¬ mÃ¬nh hiá»ƒu nÃ³ lÃ  háº¡ táº§ng cá»§a há»‡ thá»‘ng, bao gá»“m mÃ¡y chá»§, máº¡ng, gateway, database, táº¥t cáº£ nhá»¯ng thá»© cáº§n thiáº¿t Ä‘á»ƒ triá»ƒn khai á»©ng dá»¥ng cá»§a chÃºng ta trÃªn mÃ´i trÆ°á»ng server. Infrastructure as Code thÃ¬ cháº¯c cÃ³ láº½ Ä‘Æ°á»£c sá»­ dá»¥ng phá»• biáº¿n nháº¥t trÃªn mÃ´i trÆ°á»ng Cloud.

VÃ­ dá»¥ á»Ÿ trÃªn AWS Cloud, bÃ¬nh thÆ°á»ng thÃ¬ ta sáº½ Ä‘Äƒng nháº­p lÃªn web console, rá»“i ta cáº§n mÃ¡y áº£o thÃ¬ ta thao tÃ¡c trÃªn web Ä‘á»ƒ táº¡o mÃ¡y áº£o (EC2), ta cáº§n database thÃ¬ ta sáº½ thao tÃ¡c trÃªn web Ä‘á»ƒ táº¡o database. VÃ  tá»« tá»« thÃ¬ háº¡ táº§ng há»‡ thá»‘ng cá»§a chÃºng sáº½ phÃ¬nh to ra, Ä‘Ã¢y lÃ  lÃºc ta sáº½ gáº·p váº¥n Ä‘á», ta sáº½ khÃ´ng biáº¿t há»‡ thá»‘ng hiá»‡n táº¡i ta Ä‘ang cÃ³ nhá»¯ng gÃ¬, cho dÃ¹ ta cÃ³ nhá»› Ä‘i ná»¯a thÃ¬ lá»¡ ngÆ°á»i quáº£n lÃ½ cloud Ä‘Ã³ nghá»‰ viá»‡c, ngÆ°á»i má»›i vÃ o sáº½ lÃ m sao biáº¿t Ä‘Æ°á»£c háº¡ táº§ng hiá»‡n táº¡i? NgoÃ i ra, náº¿u lá»¡ cÃ³ ai Ä‘Ã³ xÃ³a EC2 cá»§a ta thÃ¬ sao, ta pháº£i táº¡o láº¡i nÃ³ báº±ng tay, mÃ  ta Ä‘Ã¢u biáº¿t lÃ  tháº±ng EC2 lÃºc trÆ°á»›c nÃ³ táº¡o ra vá»›i config tháº¿ nÃ o, cho dÃ¹ cÃ³ docs Ä‘i ná»¯a thÃ¬ viá»‡c táº¡o láº¡i ráº¥t máº¥t thá»i gian. VÃ  náº¿u lá»¡ nguyÃªn háº¡ táº§ng cloud nÃ³ down luÃ´n thÃ¬ sao, khÃ´ng láº» ta pháº£i táº¡o láº¡i nguyÃªn cÃ¡i háº¡ táº§ng há»‡ thá»‘ng tá»« Ä‘áº§u? ThÃ¬ IaC sáº½ giÃºp ta giáº£i quyáº¿t nhá»¯ng váº¥n trÃªn, ta sáº½ viáº¿t nhá»¯ng file Ä‘á»ƒ describe vÃ  backup láº¡i háº¡ táº§ng cá»§a chÃºng ta, náº¿u cÃ³ viá»‡c gÃ¬ xáº£y ra nhÆ° nguyÃªn háº¡ táº§ng down hoáº·c ai Ä‘Ã³ sá»­a gÃ¬ sai trÃªn háº¡ táº§ng cá»§a ta thÃ¬ ta cÃ³ thá»ƒ dá»… dÃ ng triá»ƒn khai nÃ³ láº¡i má»™t cÃ¡ch dá»… dÃ ng.

**Terraform**
---------

ThÃ¬ trong máº£ng IaC nÃ y thÃ¬ tool mÃ  thÃ´ng dá»¥ng nháº¥t á»Ÿ thá»i Ä‘iá»ƒm hiá»‡n táº¡i cháº¯c cÃ³ láº½ lÃ  Terraform. Terraform lÃ  má»™t open-source cá»§a HashiCorp, chuyÃªn dÃ¹ng Ä‘á»ƒ provisioning infrastructure, ta chá»‰ viá»‡c viáº¿t code, rá»“i gÃµ má»™t vÃ i cÃ¢u CLI Ä‘Æ¡n giáº£n, nÃ³ sáº½ táº¡o ra Infrastructure cho ta, thay vÃ¬ ta vá»›i lÃªn web console báº¥m báº¥m ráº¥t tá»‘n thá»i gian.

Flow cá»§a terraform sáº½ nhÆ° sau, ta viáº¿t code, xong ta gÃµ cÃ¢u lá»‡nh CLI, vÃ  Ä‘á»£i nÃ³ cung cáº¥p infrastructure, sau khi nÃ³ táº¡o xong thÃ¬ nÃ³ sáº½ táº¡o ra má»™t file state Ä‘á»ƒ lÆ°u láº¡i kiáº¿n trÃºc háº¡ táº§ng hiá»‡n táº¡i cá»§a ta.
  ![alt](../images/terra1.png)

ThÃ¬ cÅ©ng cÃ³ nhiá»u tool khÃ¡c cÃ³ thá»ƒ lÃ m Ä‘Æ°á»£c viá»‡c nÃ y nhÆ° lÃ  Ansible cháº³ng háº¡n, nhÆ°ng tháº±ng Ansible nÃ³ lÃ  má»™t Configuration Management tool chá»© nÃ³ khÃ´ng pháº£i Ä‘Æ°á»£c táº¡o ra Ä‘á»ƒ táº­p trung cho máº£ng IaC, nÃªn ta dÃ¹ng nÃ³ thÃ¬ sáº½ tá»‘n cÃ´ng cháº¡y nhá»¯ng thá»© khÃ´ng cáº§n thiáº¿t ğŸ˜.

Äá»ƒ triá»ƒn khai má»™t á»©ng dá»¥ng thÃ¬ ta cÃ³ thá»ƒ lÃ m nguyÃªn flow sau Ä‘Ã¢y, dÃ¹ng Terraform Ä‘á»ƒ táº¡o háº¡ táº§ng, sau Ä‘Ã³ dÃ¹ng Ansible Ä‘á»ƒ setup nhá»¯ng thá»© cáº§n thiáº¿t cho server, nhÆ° install docker cháº³ng háº¡n, setup CI tool trÃªn server. Sau Ä‘Ã³ thÃ¬ ta dÃ¹ng docker hoáº·c kubernetes Ä‘á»ƒ cháº¡y á»©ng dá»¥ng cá»§a ta.
  ![alt](../images/terra2.png)

**Táº¡i sao nÃªn dÃ¹ng Terraform**
ÄÃ¢y lÃ  4 Ä‘iá»ƒm lá»£i cá»§a Terraform so vá»›i cÃ¡c cÃ´ng cá»¥ khÃ¡c:

Dá»… xÃ i.
Open source vÃ  miá»…n phÃ­.
Declarative programing: chá»‰ diá»…n táº£ nhá»¯ng thá»© báº¡n cáº§n vÃ  Terraform lÃ m cho báº¡n.
CÃ³ thá»ƒ cung cáº¥p háº¡ táº§ng cho nhiá»u cloud khÃ¡c nhau nhÆ° AWS, GCP, Azure trong cÃ¹ng má»™t file cáº¥u hÃ¬nh, nÃ y ta gá»i lÃ  Cloud-agnostic.
Tá»›i Ä‘Ã¢y thÃ¬ ta nÃ³i nhiá»u rá»“i, giá» sáº½ lÃ m má»™t vÃ­ dá»¥ nhá» Ä‘á»ƒ ta hiá»ƒu hÆ¡n. Trong series nÃ y mÃ¬nh sáº½ dÃ¹ng Terraform Ä‘á»ƒ provisioning háº¡ táº§ng trÃªn AWS (táº¡i máº¥y cloud cÃ¡i khÃ¡c mÃ¬nh chÆ°a xÃ i ğŸ˜‚).

VÃ  Ä‘á»ƒ lÃ m Ä‘Æ°á»£c thÃ¬ yÃªu cáº§u lÃ  báº¡n pháº£i cÃ³ tÃ i khoáº£n AWS nhÃ©, vÃ  ta táº¡o má»™t IAM user vÃ  cho nÃ³ admin premission, xong ta láº¥y access key cá»§a nÃ³ config vÃ o mÃ¡y ta nhÃ©. Táº¡o má»™t file á»Ÿ Ä‘Æ°á»ng dáº«n ~/.aws/credentials vá»›i ná»™i dung sau:
```
[default]
aws_access_key_id=<your-key>
aws_secret_access_key=<your-key>
```

**HÆ°á»›ng dáº«n cÃ i Ä‘áº·t Terraform**
- https://learn.hashicorp.com/tutorials/terraform/install-cli.

**â€œHello Terraform!â€**
á» bÃ i vÃ­ dá»¥ nÃ y ta sáº½ dÃ¹ng Terraform Ä‘á»ƒ táº¡o má»™t EC2 trÃªn AWS Cloud, ngÃ´n ngá»¯ Terraform sá»­ dá»¥ng gá»i lÃ  HashiCorp Configuration Language (HCL).

  ![alt](../images/hello_terra.png)
CÃ¡c bÆ°á»›c ta thá»±c hiá»‡n nhÆ° sau:

1.  Viáº¿t terraform file.
2.  Cáº¥u hÃ¬nh AWS provider.
3.  Khá»i táº¡o Terraform báº±ng cÃ¢u lá»‡nhÂ `terraform init`.
4.  Triá»ƒn khai EC2 instance báº±ng cÃ¢u lá»‡nhÂ `terraform apply`.
5.  XÃ³a EC2 báº±ng cÃ¢u lá»‡nhÂ `terraform destroy`.

 ![alt](../images/hello_terra2.png)

Táº¡o má»™t file tÃªn lÃ  main.tf vÃ  ta gÃµ Ä‘oáº¡n code sau Ä‘Ã¢y:
```
provider "aws" {
  region = "us-west-2"
}
```
ÄÃ¢y lÃ  ta sáº½ chá»‰ Ä‘á»‹nh ta sá»­ dá»¥ng aws provider, vÃ  resource cá»§a chÃºng ta sáº½ Ä‘Æ°á»£c táº¡o á»Ÿ region lÃ  us-west-2. Sau Ä‘Ã³ ta thÃªm vÃ o Ä‘oáº¡n code Ä‘á»ƒ mÃ´ táº£ EC2 cá»§a chÃºng ta:
```
provider "aws" {
  region = "us-west-2"
}

resource "aws_instance" "hello" {
  ami           = "ami-09dd2e08d601bff67"
  instance_type = "t2.micro"
  tags = {
    Name = "HelloWorld"
  }
}
```
- á» trÃªn ta sá»­ dá»¥ng má»™t block tÃªn lÃ  resources, Ä‘Ã¢y lÃ  block quan trá»ng nháº¥t cá»§a terraform, ta sáº½ sá»­ dá»¥ng block nÃ y Ä‘á»ƒ táº¡o resource cá»§a chÃºng ta. PhÃ­a sau resources thÃ¬ ta sáº½ cÃ³ thÃªm giÃ¡ trá»‹ ná»¯a lÃ  resource type mÃ  ta muá»‘n táº¡o (cÃ¡i nÃ y phá»¥ thuá»™c vÃ o provider cá»§a chÃºng ta sáº½ cung cáº¥p nhá»¯ng resource type nÃ o) , á»Ÿ trÃªn resource type cá»§a ta lÃ  aws_instance, vÃ  giÃ¡ trá»‹ cuá»‘i cÃ¹ng lÃ  tÃªn cá»§a resource Ä‘Ã³, nÃ y ta muá»‘n Ä‘áº·t gÃ¬ cÅ©ng Ä‘Æ°á»£c.
 ![alt](../images/hello_terra3.png)
- Äá»ƒ xem nhá»¯ng thuá»™c tÃ­nh cá»§a má»™t resource nÃ o Ä‘Ã³, ta lÃªn trang https://registry.terraform.io/ Ä‘á»ƒ xem. VÃ­ dá»¥ á»Ÿ Ä‘Ã¢y mÃ¬nh cáº§n xem thuá»™c tÃ­nh cá»§a aws_instance thuá»™c aws provider.
- Má»—i resource cá»§a chÃºng ta sáº½ cÃ³ giÃ¡ trá»‹ arguments (Ä‘áº§u vÃ o) vÃ  attributes (Ä‘áº§u ra) tÃ¹y thuá»™c vÃ o resource type, vÃ  attributes sáº½ cÃ³ loáº¡i gá»i lÃ  computed attributes, lÃ  nhá»¯ng attributes ta chá»‰ biáº¿t Ä‘Æ°á»£c khi resource Ä‘Ã£ Ä‘Æ°á»£c táº¡o ra.
 ![alt](../images/hello_terra4.png)
- Xong khi ta viáº¿t config xong háº¿t, thÃ¬ ta má»Ÿ terrminal lÃªn vÃ  gÃµ terraform init, bÆ°á»›c nÃ y lÃ  báº¯t buá»™c khi ta viáº¿t má»™t cáº¥u hÃ¬nh cho má»™t háº¡ táº§ng má»›i, nÃ³ sáº½ táº£i code cá»§a provider xuá»‘ng folder hiá»‡n táº¡i mÃ  ta viáº¿t file main.tf.
```
$ terraform init
Initializing the backend...

Initializing provider plugins...
- Finding latest version of hashicorp/aws...
- Installing hashicorp/aws v3.66.0...
- Installed hashicorp/aws v3.66.0 (signed by HashiCorp)

Terraform has created a lock file .terraform.lock.hcl to record the provider
selections it made above. Include this file in your version control repository
so that Terraform can guarantee to make the same selections by default when
you run "terraform init" in the future.
```
Sau khi init xong, ta gÃµ tiáº¿p cÃ¢u lá»‡nh apply Ä‘á»ƒ nÃ³ táº¡o EC2 cho ta.

```
$ terraform apply -auto-approve
Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the
following symbols:
  + create

Terraform will perform the following actions:

  # aws_instance.hello will be created
  + resource "aws_instance" "hello" {
      + ami                                  = "ami-09dd2e08d601bff67"
...
Plan: 1 to add, 0 to change, 0 to destroy.
aws_instance.hello: Creating...
aws_instance.hello: Still creating... [10s elapsed]
aws_instance.hello: Still creating... [20s elapsed]
...
Apply complete! Resources: 1 added, 0 changed, 0 destroyed.
```
BÃ¢y giá» náº¿u ta muá»‘n xÃ³a EC2 Ä‘i, ta chá»‰ cáº§n cháº¡y cÃ¢u lá»‡nh destroy.
```
$ terraform destroy -auto-approve
aws_instance.hello: Refreshing state... [id=i-0ec68130272c45152]

Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the
following symbols:
  - destroy

Terraform will perform the following actions:

  # aws_instance.hello will be destroyed
  - resource "aws_instance" "hello" {
      - ami                                  = "ami-09dd2e08d601bff67" -> null
...
Plan: 0 to add, 0 to change, 1 to destroy.
aws_instance.hello: Destroying... [id=i-0ec68130272c45152]
aws_instance.hello: Still destroying... [id=i-0ec68130272c45152, 10s elapsed]
aws_instance.hello: Still destroying... [id=i-0ec68130272c45152, 20s elapsed]
aws_instance.hello: Still destroying... [id=i-0ec68130272c45152, 30s elapsed]
aws_instance.hello: Destruction complete after 35s

Destroy complete! Resources: 1 destroyed.
```

**Káº¿t luáº­n**
Váº­y lÃ  ta Ä‘Ã£ tÃ¬m hiá»ƒu xong vá» IaC lÃ  gÃ¬ vÃ  Terraform sá»­ dá»¥ng nhÆ° tháº¿ nÃ o. NhÆ° báº¡n tháº¥y thÃ¬ vá»›i Terraform, ta táº¡o vÃ  xÃ³a resource Ä‘i má»™t cÃ¡ch ráº¥t dá»… dÃ ng. Náº¿u cÃ³ tháº¯c máº¯c hoáº·c cáº§n giáº£i thÃ­ch rÃµ thÃªm chá»— nÃ o thÃ¬ cÃ¡c báº¡n cÃ³ thá»ƒ há»i dÆ°á»›i pháº§n comment. BÃ i tiáº¿p theo mÃ¬nh sáº½ nÃ³i sÃ¢u hÆ¡n vá» cÃ¡ch viáº¿t file config vÃ  life cycle cá»§a Terraform khi nÃ³ táº¡o resoruce, mong cÃ¡c báº¡n theo dÃµi series cá»§a mÃ¬nh nhÃ©.

