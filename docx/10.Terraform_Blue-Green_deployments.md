á» bÃ i nÃ y ta sáº½ tÃ¬m hiá»ƒu cÃ¡ch thá»±c hiá»‡n ZDD cho má»™t resource phá»©c táº¡p hÆ¡n lÃ  Autoscaling Group báº±ng phÆ°Æ¡ng phÃ¡p Blue/Green deployments.

![](https://images.viblo.asia/66d5204c-526a-4766-a4a0-71a2d778406e.jpg)

BÃ i nÃ y mÃ¬nh tham kháº£o tá»« cuá»‘n Terraform in Action, cÃ¡c báº¡n nÃªn Ä‘á»c thá»­ cuá»‘n nÃ y vÃ¬ nÃ³ ráº¥t hay ğŸ˜.

Blue/Green deployments
----------------------

Blue/Green deployments lÃ  má»™t phÆ°Æ¡ng phÃ¡p giÃºp ta thá»±c hiá»‡n Zero-downtime khi triá»ƒn khai má»™t version má»›i cá»§a á»©ng dá»¥ng. ÄÃ¢y lÃ  phÆ°Æ¡ng phÃ¡p cÅ© nháº¥t nhÆ°ng láº¡i Ä‘Æ°á»£c sá»­ dá»¥ng nhiá»u nháº¥t, cÃ¡c phÆ°Æ¡ng phÃ¡p cáº£i tiáº¿n hÆ¡n cá»§a Blue/Green deployments lÃ  Rolling Blue/Green hoáº·c Canary deployments.

Äá»ƒ thá»±c hiá»‡n Blue/Green deployment thÃ¬ á»©ng dá»¥ng cá»§a ta sáº½ cÃ³ hai mÃ´i trÆ°á»ng production, má»™t tháº±ng sáº½ Ä‘Æ°á»£c gá»i lÃ  Blue vÃ  má»™t tháº±ng Ä‘Æ°á»£c gá»i lÃ  Green, chá»‰ má»™t trong hai tháº±ng nÃ y sáº½ á»Ÿ tráº¡ng thÃ¡iÂ liveÂ Ä‘á»ƒ nháº­n request cá»§a user, cÃ²n má»™t tháº±ng con láº¡i sáº½ á»Ÿ tráº¡ng thÃ¡iÂ idleÂ (khÃ´ng lÃ m viá»‡c).

Khi ta muá»‘n triá»ƒn khai version má»›i cá»§a á»©ng dá»¥ng, ta sáº½ triá»ƒn khai trÃªn mÃ´i trÆ°á»ng Ä‘ang á»Ÿ tráº¡ng thÃ¡i idle (cÃ³ thá»ƒ lÃ  Blue hoáº·c Green), sau Ä‘Ã³ ta kiá»ƒm ta má»i thá»© trÃªn mÃ´i trÆ°á»ng idle Ä‘Ã£ hoáº¡t Ä‘á»™ng á»•n háº¿t thÃ¬ ta chuyá»ƒn router tá»« mÃ´i trÆ°á»ng live sang idle.

![](https://images.viblo.asia/280fc352-93a7-4af7-b86e-6271943d1c76.jpg)

### Blue/Green deployments with Autoscaling Group

Trong bÃ i nÃ y chÃºng ta sáº½ lÃ m vÃ­ dá»¥ Blue/Green deployments cho resource Autoscaling Group trÃªn AWS. Kiáº¿n trÃºc cá»§a ta sáº½ bao gá»“m:

-   Virtual Private Cloud (VPC).
-   Application Load Balancer (ALB).
-   2 Autoscaling Group (Blue/Green).

![](https://images.viblo.asia/dd438d8a-1c1c-4916-8ee1-b18c2b5a4b36.jpg)

### Base resource and Application resource

Khi thá»±c hiá»‡n Blue/Green deployments, viá»‡c Ä‘áº§u tiÃªn ta cáº§n lÃ m lÃ  xÃ¡c Ä‘á»‹nh resource nÃ o lÃ  base resource vÃ  resource nÃ o lÃ  application resource. Vá»›i base resource lÃ  cÃ¡c thÃ nh pháº§n Ä‘Æ°á»£c sá»­ dá»¥ng chung vÃ  sáº½ khÃ´ng thay Ä‘á»•i nhiá»u trong quÃ¡ trÃ¬nh deploy, cÃ²n application resource cÃ³ thá»ƒ thay Ä‘á»•i nhiá»u trong quÃ¡ trÃ¬nh deploy, tháº­m chÃ­ cÃ³ thá»ƒ xÃ³a nÃ³ luÃ´n vÃ  táº¡o láº¡i tháº±ng má»›i mÃ  khÃ´ng áº£nh hÆ°á»Ÿng gÃ¬ tá»›i há»‡ thá»‘ng cá»§a ta.

VÃ­ dá»¥ vá»›i mÃ´ hÃ¬nh Autoscaling Group á»Ÿ trÃªn thÃ¬ cÃ¡c thÃ nh pháº§n thuá»™c base resource lÃ  VPC vÃ  ALB, cÃ²n application resource lÃ  Autoscaling Group. Khi ta triá»ƒn khai má»™t version má»›i cá»§a á»©ng dá»¥ng thÃ¬ cháº¯c cháº¯n lÃ  VPC cá»§a ta sáº½ giá»¯ nguyÃªn khÃ´ng thay Ä‘á»•i gÃ¬ (bá»Ÿi vÃ¬ cháº£ cÃ³ lÃ½ do gÃ¬ mÃ  ta cáº§n pháº£i táº¡o má»›i VPC Ä‘á»ƒ deploy version má»›i cá»§a á»©ng dá»¥ng cáº£), cÃ²n ALB thÃ¬ cÃ³ thá»ƒ thay Ä‘á»•i má»™t chÃºt. CÃ²n Autoscaling Group thÃ¬ ta cÃ³ thá»ƒ xÃ³a tháº±ng cÅ© vÃ  táº¡o láº¡i tháº±ng má»›i cÅ©ng Ä‘Æ°á»£c.

> Äá»‘i vá»›i cÃ¡c resource dÃ¹ng Ä‘á»ƒ lÆ°u dá»¯ liá»‡u nhÆ° lÃ  database, thÃ¬ Ä‘á»ƒ chuyá»ƒn Ä‘á»•i database giá»¯a cÃ¡c mÃ´i trÆ°á»ng lÃ  má»™t váº¥n Ä‘á» ráº¥t phá»©c táº¡p nÃªn thÃ´ng thÆ°á»ng ta sáº½ xáº¿p database vÃ o trong base resource.

![image.png](https://images.viblo.asia/3656e57e-6da1-4248-bf23-1b818b26597a.png)

VÃ  khi deploy ta chá»‰ cáº§n tÃ¡c Ä‘á»™ng tá»›i application resource, sau Ä‘Ã³ ta sáº½ tiáº¿n hÃ nh thá»±c hiá»‡n chuyá»ƒn traffic cá»§a application resource tá»« mÃ´i trÆ°á»ng live sang idle, cÃ³ thá»ƒ lÃ  tá»± Ä‘á»™ng hoáº·c lÃ m báº±ng tay.

### Implement

Ta sáº½ cÃ³ má»™t Autoscaling Group cho version 1.0, vÃ  ta gÃ¡n cho nÃ³ lÃ  Green. Sau Ä‘Ã³ á»©ng dá»¥ng cá»§a ta sáº½ cÃ³ version má»›i lÃ  2.0, ta sáº½ táº¡o thÃªm má»™t Autoscaling Group cho version 2.0 vÃ  gÃ¡n cho nÃ³ lÃ  Blue. Hiá»‡n táº¡i thÃ¬ Green sáº½ lÃ  mÃ´i trÆ°á»ng live, cÃ²n Blue sáº½ lÃ  mÃ´i trÆ°á»ng idle.

VÃ  sau Ä‘Ã³ ta sáº½ tiáº¿n hÃ nh chuyá»ƒn router cho traffic tá»« Green sang Blue báº±ng tay (viá»‡c chuyá»ƒn router nhÆ° váº­y Ä‘Æ°á»£c gá»i lÃ Â cutover). Táº¡o má»™t file tÃªn lÃ Â `main.tf`Â vá»›i Ä‘oáº¡n code sau.

```
provider "aws" {
  region  = "us-west-2"
}

variable "production" {
  default = "green"
}

module "base" {
  source     = "terraform-in-action/aws/bluegreen//modules/base"
  production = var.production
}

module "green" {
  source      = "terraform-in-action/aws/bluegreen//modules/autoscaling"
  app_version = "v1.0"
  label       = "green"
  base        = module.base
}

output "lb_dns_name" {
  value = module.base.lb_dns_name
}

```

á» trÃªn ta sáº½ sá»­ dá»¥ng module lÃ Â `terraform-in-action/aws/bluegreen`Â cho vÃ­ dá»¥ nÃ y, trong module trÃªn sáº½ cÃ³ base resource lÃ  VPC vá»›i ALB tá»« submoduleÂ `modules/autoscaling`, cÃ²n application resource lÃ  Autoscaling Group tá»« submoduleÂ `modules/autoscaling`.

á»¨ng dá»¥ng version 1.0 cá»§a ta Ä‘Æ°á»£c deploy báº±ng submoduleÂ `terraform-in-action/aws/bluegreen//modules/autoscaling`Â vÃ  ta Ä‘áº·t tÃªn cho nÃ³ lÃ  green.

Oke, giá» tiáº¿n hÃ nh deploy version 1.0 nÃ o.

```
$ terraform apply -auto-approve
...
Plan: 34 to add, 0 to change, 0 to destroy.
...
Apply complete! Resources: 34 added, 0 changed, 0 destroyed.

Outputs:

lb_dns_name = "terraforminaction-ovgcpc-lb-909615962.us-west-2.elb.amazonaws.com"

```

Äá»£i khi terraform cháº¡y xong thÃ¬ nÃ³ sáº½ in ra cho ta domain cá»§a ALB, ta truy cáº­p vÃ o domain Ä‘Ã³.

![image.png](https://images.viblo.asia/a4f199c3-f2ab-4599-b43e-75e5da694d09.png)

Tiáº¿p theo ta sáº½ deploy version 2.0 cá»§a á»©ng dá»¥ng vÃ  Ä‘áº·t tÃªn cho nÃ³ lÃ  blue.

```
...
module "green" {
  source      = "terraform-in-action/aws/bluegreen//modules/autoscaling"
  app_version = "v1.0"
  label       = "green"
  base        = module.base
}

module "blue" {
  source      = "terraform-in-action/aws/bluegreen//modules/autoscaling"
  app_version = "v2.0"
  label       = "blue"
  base        = module.base
}
...

```

Cháº¡y cÃ¢u lá»‡nh.

```
$ terraform apply -auto-approve
...
Plan: 5 to add, 0 to change, 0 to destroy.
...
Apply complete! Resources: 5 added, 0 changed, 0 destroyed.

Outputs:

lb_dns_name = "terraforminaction-ovgcpc-lb-909615962.us-west-2.elb.amazonaws.com"

```

Sau khi ta kiá»ƒm tra má»i thá»© á»Ÿ mÃ´i trÆ°á»ng blue Ä‘á»u á»•n háº¿t, ta tiáº¿n hÃ nh Ä‘á»•i router cá»§a traffic vÃ o á»©ng dá»¥ng.

### Blue/Green cutover

CÃ¡c báº¡n lÃ m viá»‡c nÃ y báº±ng má»™t cÃ¡ch Ä‘Æ¡n giáº£n lÃ  thay Ä‘á»•i giÃ¡ trá»‹ cá»§a biáº¿nÂ `production`Â trong fileÂ `main.tf`.

Chuyá»ƒn giÃ¡ trá»‹ tá»« green.

```
...
variable "production" {
  default = "green"
}
...

```

ThÃ nh blue.

```
provider "aws" {
  region  = "us-west-2"
}

variable "production" {
  default = "blue" // change here
}

module "base" {
  source     = "terraform-in-action/aws/bluegreen//modules/base"
  production = var.production
}

module "green" {
  source      = "terraform-in-action/aws/bluegreen//modules/autoscaling"
  app_version = "v1.0"
  label       = "green"
  base        = module.base
}

module "blue" {
  source      = "terraform-in-action/aws/bluegreen//modules/autoscaling"
  app_version = "v2.0"
  label       = "blue"
  base        = module.base
}

output "lb_dns_name" {
  value = module.base.lb_dns_name
}

```

Cháº¡y cÃ¢u lá»‡nh apply.

```
$ terraform apply -auto-approve
...
Plan: 0 to add, 2 to change, 0 to destroy.
...
Apply complete! Resources: 0 added, 2 changed, 0 destroyed.

Outputs:

lb_dns_name = "terraforminaction-ovgcpc-lb-909615962.us-west-2.elb.amazonaws.com"

```

Sau khi terraform cháº¡y xong, nÃ³ sáº½ chuyá»ƒn target group cá»§a ALB tá»« Autoscaling Group Green sang Blue. Ta táº£i láº¡i trang vÃ  cÃ¡c báº¡n sáº½ tháº¥y nÃ³ chuyá»ƒn thÃ nh blue vá»›i version 2.0.

![image.png](https://images.viblo.asia/7c4b12da-dd0d-4ab8-b226-0f2131e56066.png)

Oke, ta lÃ m má»™t vÃ­ dá»¥ Ä‘Æ¡n giáº£n vá» Blue/Green deployments thÃ nh cÃ´ng ğŸ˜. Khi ta thá»±c hiá»‡n Blue/Green deployments tháº¿ nÃ y thÃ¬ ta cÃ³ thá»ƒ giáº£m thá»i gian down time cá»§a á»©ng dá»¥ng nhiá»u nháº¥t cÃ³ thá»ƒ.

BÃ¢y giá» thÃ¬ ta Ä‘ang cÃ³ hai mÃ´i trÆ°á»ng production lÃ  Green vÃ  Blue, náº¿u ta láº¡i cÃ³ má»™t version má»›i cá»§a á»©ng dá»¥ng lÃ  3.0, ta chá»‰ viá»‡c cáº­p nháº­t giÃ¡ trá»‹ app_version cá»§aÂ `module green`Â láº¡i thÃ nh 3.0 vÃ  chuyá»ƒn giÃ¡ trá»‹ cá»§a biáº¿nÂ `production`Â láº¡i thÃ nh green.

Ta nhá»› cháº¡y cÃ¢u lá»‡nh destroy Ä‘á»ƒ xÃ³a resource nhÃ©.

Káº¿t luáº­n
--------

Váº­y lÃ  ta Ä‘Ã£ tÃ¬m hiá»ƒu xong vá» Blue/Green deployments, Ä‘Ã¢y chá»‰ lÃ  má»™t trong nhá»¯ng phÆ°Æ¡ng phÃ¡p Ä‘á»ƒ thá»±c hiá»‡n Zero-downtime deployments, cÃ¡c báº¡n cÃ³ thá»ƒ tÃ¬m hiá»ƒu thÃªm vá» Rolling Blue/Green deployments vÃ  Canary deployments Ä‘á»ƒ ta cÃ³ thÃªm nhiá»u sá»± lá»±a chá»n ná»¯a khi tiáº¿n hÃ nh deploy á»©ng dá»¥ng vá»›i version má»›i.