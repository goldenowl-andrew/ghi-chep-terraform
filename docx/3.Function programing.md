Terraform há»— trá»£ ta láº­p trÃ¬nh theo cÃ¡ch functional programming, vÃ  ta sáº½ nÃ³i qua cÃ¡ch sá»­ dá»¥ng cÃ¡c function trong terraform, expressions xÃ i ra sao, ...

Provisioning EC2
----------------

Ta sáº½ lÃ m vÃ­ dá»¥ vá» EC2 Ä‘á»ƒ tÃ¬m hiá»ƒu vá» cÃ¡c khÃ¡i niá»‡m trÃªn. Táº¡o má»™t file tÃªn lÃ  `main.tf`

    provider "aws" {
      region = "us-west-2"
    }
    
    data "aws_ami" "ubuntu" {
      most_recent = true
    
      filter {
        name   = "name"
        values = ["ubuntu/images/hvm-ssd/ubuntu-focal-20.04-amd64-server-*"]
      }
    
      owners = ["099720109477"]
    }
    
    resource "aws_instance" "hello" {
      ami           = data.aws_ami.ubuntu.id
      instance_type = "t2.micro"
    }
    

Cháº¡y `terraform init` vÃ  `terraform apply`, sau Ä‘Ã³ lÃªn AWS ta sáº½ tháº¥y EC2 cá»§a ta. Vá»›i Ä‘oáº¡n code trÃªn thÃ¬ EC2 cá»§a ta luÃ´n luÃ´n cÃ³ instance\_type lÃ  t2.micro, vÃ  náº¿u ta muá»‘n táº¡o láº¡i EC2 mÃ  sáº½ cÃ³ instance\_type khÃ¡c máº¡nh hÆ¡n thÃ¬ lÃ m sao? Ta sáº½ sá»­a láº¡i code trong file terraform? Váº­y thÃ¬ khÃ´ng linh hoáº¡t cho láº¯m, mÃ  thay vÃ o Ä‘Ã³ ta sáº½ sá»­ dá»¥ng variable Ä‘á»ƒ lÃ m viá»‡c nÃ y.

### Input Variables

Ta cÃ³ thá»ƒ Ä‘á»‹nh nghÄ©a variable bÃªn trong terraform, vá»›i cÃº phÃ¡p nhÆ° sau.
![alt](../images/funtion1.png) 

Ta sáº½ dÃ¹ng variable block Ä‘á»ƒ khai bÃ¡o variable, vÃ  theo sau nÃ³ lÃ  tÃªn cá»§a variable Ä‘Ã³. á» vÃ­ dá»¥ trÃªn, ta táº¡o thÃªm má»™t file ná»¯a vá»›i tÃªn lÃ  `variable.tf` (nÃ y báº¡n Ä‘áº·t tÃªn gÃ¬ cÅ©ng Ä‘Æ°á»£c nha) Ä‘á»ƒ khai bÃ¡o biáº¿n cá»§a ta.

    variable "instance_type" {
      type = string
      description = "Instance type of the EC2"
    }
    

Thuá»™c tÃ­nh lÃ  type Ä‘á»ƒ chá»‰ Ä‘á»‹nh type cá»§a biáº¿n Ä‘Ã³, thuá»™c tÃ­nh description dÃ¹ng Ä‘á»ƒ ghi láº¡i mÃ´ táº£ cho ngÆ°á»i Ä‘á»c biáº¿n Ä‘Ã³ cÃ³ Ã½ nghÄ©a gÃ¬. **Chá»‰ cÃ³ thuá»™c tÃ­nh type lÃ  báº¯t buá»™c pháº£i khai bÃ¡o**. Trong terraform thÃ¬ má»™t biáº¿n sáº½ cÃ³ cÃ¡c type sau Ä‘Ã¢y:

*   Basic type: string, number, bool
*   Complex type: list(), set(), map(), object(), tuple()

> Trong terraform, type number vÃ  type bool sáº½ Ä‘Æ°á»£c convert thÃ nh type string khi cáº§n thiáº¿t. NghÄ©a lÃ  1 sáº½ thÃ nh "1", true sáº½ thÃ nh "true"

Äá»ƒ truy cáº­p Ä‘Æ°á»£c giÃ¡ trá»‹ cá»§a variable thÃ¬ ta sáº½ dÃ¹ng theo cÃº phÃ¡p sau `var.<VARIABLE_NAME>`, cáº­p nháº­t láº¡i file `main.tf`

    provider "aws" {
      region = "us-west-2"
    }
    
    data "aws_ami" "ubuntu" {
      most_recent = true
    
      filter {
        name   = "name"
        values = ["ubuntu/images/hvm-ssd/ubuntu-focal-20.04-amd64-server-*"]
      }
    
      owners = ["099720109477"]
    }
    
    resource "aws_instance" "hello" {
      ami           = data.aws_ami.ubuntu.id
      instance_type = var.instance_type # change here
    }
    

á» thuá»™c tÃ­nh instance\_type thay vÃ¬ gÃ¡n cá»©ng thÃ¬ bÃ¢y giá» ta sáº½ dÃ¹ng biáº¿n **var.instance\_type**.

### GÃ¡n giÃ¡ trá»‹ cho variable

Äá»ƒ gÃ¡n giÃ¡ trá»‹ cho biáº¿n, ta sáº½ táº¡o má»™t file tÃªn lÃ  terraform.tfvars

    instance_type = "t2.micro"
    

Khi ta cháº¡y `terraform apply` thÃ¬ file terraform.tfvars sáº½ Ä‘Æ°á»£c terraform sá»­ dá»¥ng máº·c Ä‘á»‹nh Ä‘á»ƒ load giÃ¡ trá»‹ cho biáº¿n, náº¿u ta khÃ´ng muá»‘n dÃ¹ng máº·c Ä‘á»‹nh, thÃ¬ khi cháº¡y cÃ¢u lá»‡nh apply ta thÃªm vÃ o option lÃ  -var-file ná»¯a. Táº¡o má»™t file tÃªn lÃ  production.tfvars

    instance_type = "t3.small"
    

Khi cháº¡y CI/CD cho production, ta chá»‰ Ä‘á»‹nh file variable nhÆ° sau:

    terraform apply -var-file="production.tfvars"
    

BÃ¢y giá» thÃ¬ giÃ¡ trá»‹ instance\_type cá»§a ta sáº½ linh hoáº¡t hÆ¡n nhiá»u.

### Validating variables

Ta cÅ©ng cÃ³ thá»ƒ Ä‘á»‹nh nghÄ©a biáº¿n nÃ y chá»‰ cÃ³ thá»ƒ Ä‘Æ°á»£c gÃ¡n nhá»¯ng giÃ¡ trá»‹ mÃ  ta cho phÃ©p báº±ng cÃ¡ch sá»­ dÃ¹ng thuá»™c tÃ­nh validating, nhÆ° sau:

    variable "instance_type" {
      type = string
      description = "Instance type of the EC2"
    
      validation {
        condition = contains(["t2.micro", "t3.small"], var.instance_type)
        error_message = "Value not allow."
      }
    }
    

á» file trÃªn ta sáº½ dÃ¹ng function contains Ä‘á»ƒ kiá»ƒm tra giÃ¡ trá»‹ cá»§a biáº¿n instance\_type nÃ y chá»‰ Ä‘Æ°á»£c náº±m trong máº£ng array ta cho phÃ©p, náº¿u khÃ´ng thÃ¬ khi ta cháº¡y cÃ¢u lá»‡nh apply báº¡n sáº½ tháº¥y lá»—i lÃ  á»Ÿ trÆ°á»ng error\_message Ä‘Æ°á»£c in ra. Sá»­a láº¡i file terraform.tfvars

    instance_type = "t3.micro"
    

Cháº¡y terraform apply.

    $ terraform apply
    â•·
    â”‚ Error: Invalid value for variable
    â”‚ 
    â”‚   on variable.tf line 1:
    â”‚    1: variable "instance_type" {
    â”‚ 
    â”‚ Value not allow.
    â”‚ 
    â”‚ This was checked by the validation rule at variable.tf:5,3-13.
    â•µ
    

Sá»­ dá»¥ng validating Ä‘á»ƒ kiá»ƒm soÃ¡t giÃ¡ trá»‹ cá»§a biáº¿n mÃ  báº¡n muá»‘n. Sá»­a láº¡i file terraform.tfvars nhÆ° cÅ© nhÃ©. ThÃ´ng thÆ°á»ng khi táº¡o EC2 xong, ta sáº½ muá»‘n xem Ä‘á»‹a chá»‰ IP cá»§a nÃ³, Ä‘á»ƒ lÃ m Ä‘Æ°á»£c viá»‡c Ä‘Ã³ thÃ¬ ta sá»­ dá»¥ng output block.

### Output

GiÃ¡ trá»‹ cá»§a output block sáº½ Ä‘Æ°á»£c in ra terminal, cÃº phÃ¡p cá»§a output nhÆ° sau.

![alt](../images/funtion2.png)

Äá»ƒ in Ä‘Æ°á»£c giÃ¡ trá»‹ public IP cá»§a EC2, ta thÃªm vÃ o file `main.tf` Ä‘oáº¡n code sau:

    ...
    
    output "ec2" {
      value = {
        public_ip = aws_instance.hello.public_ip
      }
    }
    

Báº¡n cháº¡y láº¡i cÃ¢u lá»‡nh apply, ta sáº½ tháº¥y giÃ¡ trá»‹ IP cá»§a EC2 Ä‘Æ°á»£c in ra terminal.

    $ terraform apply -auto-approve
    ...
    
    Apply complete! Resources: 1 added, 0 changed, 0 destroyed.
    
    Outputs:
    
    ec2 = {
      "public_ip" = "52.36.124.230"
    }
    

Oke, bÃ¢y giá» thÃ¬ ta Ä‘Ã£ biáº¿t cÃ¡ch sá»­ dá»¥ng varibale vÃ  output. Tiáº¿p theo, náº¿u ta muá»‘n thÃªm má»™t EC2 ná»¯a thÃ¬ sao? Trong file `main.tf` ta sáº½ copy ra thÃªm má»™t EC2 ná»¯a, nhÆ° sau:

    provider "aws" {
      region = "us-west-2"
    }
    
    data "aws_ami" "ubuntu" {
      most_recent = true
    
      filter {
        name   = "name"
        values = ["ubuntu/images/hvm-ssd/ubuntu-focal-20.04-amd64-server-*"]
      }
    
      owners = ["099720109477"]
    }
    
    resource "aws_instance" "hello1" {
      ami           = data.aws_ami.ubuntu.id
      instance_type = var.instance_type
    }
    
    resource "aws_instance" "hello2" {
      ami           = data.aws_ami.ubuntu.id
      instance_type = var.instance_type
    }
    
    output "ec2" {
      value = {
        public_ip1 = aws_instance.hello1.public_ip
        public_ip2 = aws_instance.hello2.public_ip
      }
    }
    

Ta sáº½ thÃªm má»™t resource block cho EC2 thá»© hai, vÃ  á»Ÿ pháº§n output, ta cáº­p nháº­t láº¡i Ä‘á»ƒ nÃ³ cÃ³ thá»ƒ in ra Ä‘Æ°á»£c IP cá»§a hai con EC2. Má»i thá»© Ä‘á»u khÃ´ng cÃ³ gÃ¬ phá»©c táº¡p háº¿t, nhÆ°ng náº¿u giá» ta muá»‘n 100 con EC2 thÃ¬ sao? Ta cÃ³ thá»ƒ copy ra 100 resource block, nhÆ°ng khÃ´ng ai lÃ m váº­y ğŸ˜‚, mÃ  ta sáº½ sá»­ dá»¥ng count parameter.

### Count parameter

Count lÃ  má»™t **meta argument**, lÃ  má»™t thuá»™c tÃ­nh trong terraform chá»© khÃ´ng pháº£i cá»§a resource type thuá»™c provider, á»Ÿ bÃ i 1 ta Ä‘Ã£ nÃ³i resource type block chá»‰ cÃ³ chá»©a cÃ¡c thuá»™c tÃ­nh mÃ  provider cung cáº¥p cho, cÃ²n meta argument lÃ  thuá»™c tÃ­nh cá»§a terraform => nghÄ©a lÃ  ta cÃ³ thá»ƒ sá»­ dá»¥ng nÃ³ á»Ÿ báº¥t kÃ¬ resource block nÃ o. Cáº­p nháº­t láº¡i file `main.tf` mÃ  sáº½ táº¡o ra 5 EC2 nhÆ° sau:

    provider "aws" {
      region = "us-west-2"
    }
    
    data "aws_ami" "ubuntu" {
      most_recent = true
    
      filter {
        name   = "name"
        values = ["ubuntu/images/hvm-ssd/ubuntu-focal-20.04-amd64-server-*"]
      }
    
      owners = ["099720109477"]
    }
    
    resource "aws_instance" "hello" {
      count         = 5
      ami           = data.aws_ami.ubuntu.id
      instance_type = var.instance_type
    }
    
    output "ec2" {
      value = {
        public_ip1 = aws_instance.hello[0].public_ip
        public_ip2 = aws_instance.hello[1].public_ip
        public_ip3 = aws_instance.hello[2].public_ip
        public_ip4 = aws_instance.hello[3].public_ip
        public_ip5 = aws_instance.hello[4].public_ip
      }
    }
    

BÃ¢y giá» thÃ¬ khi ta cháº¡y apply, terraform sáº½ táº¡o ra cho ta 5 EC2. Báº¡n sáº½ Ä‘á»ƒ Ã½ lÃ  á»Ÿ pháº§n output, Ä‘á»ƒ truy cáº­p Ä‘Æ°á»£c resource, thÃ¬ ta sáº½ dÃ¹ng thÃªm dáº¥u `[]` vÃ  giÃ¡ trá»‹ index cá»§a resource. BÃ¬nh thÆ°á»ng, Ä‘á»ƒ truy cáº­p Ä‘Æ°á»£c resource, ta dÃ¹ng theo cÃº phÃ¡p `<RESOURCE TYPE>.<NAME>`, nhÆ°ng khi ta dÃ¹ng count thÃ¬ ta sáº½ truy cáº­p resource theo cÃº phÃ¡p sau `<RESOURCE TYPE>.<NAME>[index]`.

BÃ¢y giá» ta Ä‘Ã£ giáº£i quyáº¿t Ä‘Æ°á»£c váº¥n Ä‘á» copy resource ra khi cáº§n táº¡o nÃ³ vá»›i sá»‘ lÆ°á»£ng nhiá»u hÆ¡n, nhÆ°ng á»Ÿ pháº§n output, ta váº«n pháº£i ghi ra tá»«ng resource riÃªng láº». Ta sáº½ giáº£i quyáº¿t nÃ³ báº±ng cÃ¡ch sá»­ dá»¥ng for expressions.

### For expressions

For cho phÃ©p ta duyá»‡t qua má»™t list, cÃº phÃ¡p cá»§a lá»‡nh for nhÆ° sau:

    for <value> in <list> : <return value>
    

VÃ­ dá»¥ dÃ¹ng for:

*   Táº¡o ra má»™t array má»›i vá»›i giÃ¡ trá»‹ cá»§a array má»›i sáº½ Ä‘Æ°á»£c upper: `[for s in var.words : upper(s)]`
*   Táº¡o ra má»™t object má»›i vá»›i value cá»§a object Ä‘Æ°á»£c upper: `{ for k, v in var.words : k => upper(s) }`

Ta sáº½ dÃ¹ng for Ä‘á»ƒ rÃºt gá»n pháº§n output IP cá»§a EC2. Cáº­p nháº­t láº¡i file `main.tf`

    ...
    
    resource "aws_instance" "hello" {
      count         = 5
      ami           = data.aws_ami.ubuntu.id
      instance_type = var.instance_type
    }
    
    output "ec2" {
      value = {
        public_ip = [ for v in aws_instance.hello : v.public_ip ]
      }
    }
    

Pháº§n output trÃªn sáº½ in ra cho ta giÃ¡ trá»‹ public\_ip lÃ  má»™t máº£ng IP cá»§a táº¥t cáº£ EC2 Ä‘Æ°á»£c táº¡o ra. CÃ²n náº¿u báº¡n muá»‘n in output ra theo kiá»ƒu `{ public_ip1: <value>, public_ip2: <value> }` thÃ¬ ta cÃ³ thá»ƒ dÃ¹ng format function.

### Format function

HÃ m format sáº½ giÃºp ta ná»‘i chuá»—i theo dáº¡ng ta muá»‘n, cáº­p nháº­t output láº¡i nhÆ° sau:

    ...
    
    resource "aws_instance" "hello" {
      count         = 5
      ami           = data.aws_ami.ubuntu.id
      instance_type = var.instance_type
    }
    
    output "ec2" {
      value = { for i, v in aws_instance.hello : format("public_ip%d", i + 1) => v.public_ip }
    }
    

Khi báº¡n terraform plan Ä‘á»ƒ kiá»ƒm tra, sáº½ tháº¥y output lÃºc nÃ y sáº½ lÃ  dáº¡ng `{ public_ip1: <value>, public_ip2: <value> }`.

    $ terraform plan
    ...
    Changes to Outputs:
      + ec2 = {
          + public_ip1 = (known after apply)
          + public_ip2 = (known after apply)
          + public_ip3 = (known after apply)
          + public_ip4 = (known after apply)
          + public_ip5 = (known after apply)
        }
    
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    
    Note: You didn't use the -out option to save this plan, so Terraform can't guarantee to take exactly these actions if you
    run "terraform apply" now.
    

Tá»›i Ä‘Ã¢y thÃ¬ ta Ä‘Ã£ biáº¿t Ä‘Æ°á»£c cÃ¡ch xÃ i má»™t sá»‘ cÃº phÃ¡p Ä‘Æ¡n giáº£n, tiáº¿p theo mÃ¬nh sáº½ chuyá»ƒn sang vÃ­ dá»¥ vá» S3 Ä‘á»ƒ nÃ³i thÃªm vá» má»™t sá»‘ function hay Ä‘Æ°á»£c sá»­ dá»¥ng ná»¯a.

Provisioning S3
---------------

á» vÃ­ dá»¥ nÃ y ta sáº½ táº¡o má»™t S3 bucket Ä‘á»ƒ host má»™t static website.
![alt](../images/funtion3.png)

Táº¡o folder má»›i vÃ  táº¡o má»™t file `main.tf`

    provider "aws" {
      region = "us-west-2"
    }
    
    resource "aws_s3_bucket" "static" {
      bucket = "terraform-series-bai3"
      acl    = "public-read"
      policy = <<POLICY
      {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Sid": "PublicReadGetObject",
            "Effect": "Allow",
            "Principal": "*",
            "Action": [
              "s3:GetObject"
            ],
            "Resource": [
              "arn:aws:s3:::terraform-series-bai3/*"
            ]
          }
        ]
      }
      POLICY
    
      website {
        index_document = "index.html"
        error_document = "error.html"
      }
    }
    

Cháº¡y `terraform init` vÃ  `terraform apply`, sau Ä‘Ã³ báº¡n sáº½ tháº¥y S3 bucket cá»§a ta trÃªn AWS.

á» file trÃªn báº¡n sáº½ tháº¥y lÃ  pháº§n policy nÃ³ hÆ¡i dÃ i, vÃ  nÃ³ lÃ  dáº¡ng chuá»—i json, nÃªn config file cá»§a ta hÆ¡i khÃ³ nhÃ¬n, ta cÃ³ thá»ƒ tÃ¡ch pháº§n policy ra má»™t file json riÃªng, vÃ  dÃ¹ng function trong terrafrom Ä‘á»ƒ import file policy Ä‘Ã³ vÃ o config file cá»§a ta.

### File function

File function sáº½ giÃºp ta táº£i ná»™i dung cá»§a má»™t file nÃ o Ä‘Ã³ vÃ o bÃªn trong config file cá»§a terraform. Táº¡o má»™t file tÃªn lÃ  s3\_static\_policy.json vÃ  copy Ä‘oáº¡n json trÃªn vÃ o.

    {
      "Version": "2012-10-17",
      "Statement": [
        {
          "Sid": "PublicReadGetObject",
          "Effect": "Allow",
          "Principal": "*",
          "Action": [
            "s3:GetObject"
          ],
          "Resource": [
            "arn:aws:s3:::terraform-series-bai3/*"
          ]
        }
      ]
    }
    

Cáº­p nháº­t láº¡i `main.tf`

    provider "aws" {
      region = "us-west-2"
    }
    
    resource "aws_s3_bucket" "static" {
      bucket = "terraform-series-bai3"
      acl    = "public-read"
      policy = file("s3_static_policy.json")
    
      website {
        index_document = "index.html"
        error_document = "error.html"
      }
    }
    

NhÆ° báº¡n tháº¥y thÃ¬ khi Ä‘á»ƒ policy vÃ o má»™t file khÃ¡c vÃ  dÃ¹ng file function import vÃ o, thÃ¬ file terraform cá»§a ta nhÃ¬n gá»n hÆ¡n nhiá»u. Tiáº¿p theo ta sáº½ tiáº¿n hÃ nh upload file lÃªn s3 bucket vÃ  truy váº­p vÃ o URL thÃ¬ ta sáº½ tháº¥y Ä‘Æ°á»£c trang web cá»§a ta. Trang web mÃ  ta host sáº½ cÃ³ giao diá»‡n nhÆ° sau.
![alt](../images/funtion4.png)
CÃ¡c báº¡n clone source code á»Ÿ Ä‘Ã¢y nhÃ© [https://github.com/hoalongnatsu/static-web.git](https://github.com/hoalongnatsu/static-web.git), sau khi clone xong thÃ¬ nhá»› xÃ³a file .git Ä‘i.

    rm -rf static-web/.git
    

ThÆ° má»¥c cá»§a ta hiá»‡n táº¡i sáº½ nhÆ° sau.

    .
    â”œâ”€â”€ main.tf
    â”œâ”€â”€ s3_static_policy.json
    â”œâ”€â”€ static-web
    â”‚   â”œâ”€â”€ README.md
    â”‚   â”œâ”€â”€ article-details.html
    ...
    â”œâ”€â”€ terraform.tfstate
    

Äá»ƒ upload file lÃªn s3 thÃ¬ ta sáº½ dÃ¹ng resource type lÃ  **aws\_s3\_bucket\_object**. Cáº­p nháº­t láº¡i file `main.tf`

    provider "aws" {
      region = "us-west-2"
    }
    
    resource "aws_s3_bucket" "static" {
      bucket = "terraform-series-bai3"
      acl    = "public-read"
      policy = file("s3_static_policy.json")
    
      website {
        index_document = "index.html"
        error_document = "error.html"
      }
    }
    
    locals {
      mime_types = {
        html  = "text/html"
        css   = "text/css"
        ttf   = "font/ttf"
        woff  = "font/woff"
        woff2 = "font/woff2"
        js    = "application/javascript"
        map   = "application/javascript"
        json  = "application/json"
        jpg   = "image/jpeg"
        png   = "image/png"
        svg   = "image/svg+xml"
        eot   = "application/vnd.ms-fontobject"
      }
    }
    
    resource "aws_s3_bucket_object" "object" {
      for_each = fileset(path.module, "static-web/**/*")
      bucket = aws_s3_bucket.static.id
      key    = replace(each.value, "static-web", "")
      source = each.value
      etag         = filemd5("${each.value}")
      content_type = lookup(local.mime_types, split(".", each.value)[length(split(".", each.value)) - 1])
    }
    

Táº¡m thá»i thÃ¬ cÃ¡c báº¡n chÆ°a cáº§n hiá»ƒu code pháº§n aws\_s3\_bucket\_object, pháº§n mÃ¬nh muá»‘n giá»›i thiá»‡u á»Ÿ Ä‘Ã¢y lÃ  fileset function, thay vÃ¬ chá»‰ táº£i má»™t file, thÃ¬ fileset sáº½ táº£i toÃ n bá»™ file trong thÆ° má»¥c Ä‘Ã³ lÃªn theo dáº¡ng set.

### Fileset function

VÃ­ dá»¥ ta cÃ³ thÆ° má»¥c nhÆ° sau

    .
    â”œâ”€â”€ index.html
    â”œâ”€â”€ index.css
    

ThÃ¬ khi ta dÃ¹ng hÃ m `fileset(path.module, "*")` ta sáº½ cÃ³ Ä‘Æ°á»£c data set nhÆ° sau:

    {
      "index.html": "index.html",
      "index.css" : "index.css"
    }
    

Vá»›i giÃ¡ trá»‹ key vÃ  value lÃ  tÃªn cá»§a file.

### Local values

Báº¡n sáº½ tháº¥y cÃ³ má»™t block ná»¯a tÃªn lÃ  locals, Ä‘Ã¢y lÃ  block giÃºp ta khai bÃ¡o má»™t giÃ¡ trá»‹ local trong file terraform vÃ  cÃ³ thá»ƒ sá»­ dá»¥ng láº¡i Ä‘Æ°á»£c nhiá»u láº§n. CÃº phÃ¡p nhÆ° sau:
![alt](../images/funtion5.png)

KhÃ´ng giá»‘ng nhÆ° variable block, ta cáº§n khai bÃ¡o type, thÃ¬ locals block ta sáº½ gÃ¡n tháº³ng giÃ¡ trá»‹ cho nÃ³. VÃ­ dá»¥ nhÆ° sau:

    locals {
      one = 1
      two = 2
      name = "max"
      flag = true
    }
    

Äá»ƒ truy cáº­p giÃ¡ trá»‹ local thÃ¬ ta dÃ¹ng cÃº phÃ¡p `local.<KEY>`. Oke, sau khi cháº¡y cÃ¢u lá»‡nh `terraform apply` láº¡i, báº¡n truy cáº­p trang web vá»›i url lÃ  `http://terraform-series-bai3.s3-website-us-west-2.amazonaws.com/` thÃ¬ sáº½ tháº¥y Ä‘Æ°á»£c trang web cá»§a ta ğŸ˜. Náº¿u báº¡n Ä‘áº·t tÃªn S3 bucket khÃ¡c thÃ¬ URL trÃªn sáº½ khÃ¡c nhÃ©.

Káº¿t luáº­n
--------

Váº­y lÃ  ta Ä‘Ã£ tÃ¬m hiá»ƒu xong vá» má»™t sá»‘ cÃ¡ch Ä‘Æ¡n giáº£n Ä‘á»ƒ láº­p trÃ¬nh Ä‘Æ°á»£c trong terraform. Sá»­ dá»¥ng varibale Ä‘á»ƒ chá»©a biáº¿n, sá»­ dá»¥ng output Ä‘á»ƒ show giÃ¡ trá»‹ ra terminal, sá»­ dá»¥ng for Ä‘á»ƒ duyá»‡t qua máº£ng, sá»­ dá»¥ng locals Ä‘á»ƒ lÆ°u giÃ¡ trá»‹ vÃ  sá»­ dá»¥ng láº¡i nhiá»u láº§n.